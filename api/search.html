<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بحث في مكتبة ناصر ابن داوود</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        .search-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .result-card {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #fff;
        }
        .result-card h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        .result-card p {
            margin-bottom: 10px;
        }
        .result-card .links a {
            margin-left: 10px;
        }
        .pagination {
            justify-content: center;
            margin-top: 20px;
        }
        @media (max-width: 576px) {
            .result-card h3 {
                font-size: 1.2rem;
            }
            .result-card .links a {
                display: inline-block;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="search-container">
        <h1 class="text-center mb-4">بحث في مكتبة ناصر ابن داوود</h1>
        <div class="input-group mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="ابحث عن كتاب أو موضوع..." aria-label="ابحث عن كتاب">
            <select id="languageSelect" class="form-select" style="max-width: 150px;">
                <option value="ar">العربية</option>
                <option value="en">English</option>
            </select>
            <button class="btn btn-primary" type="button" onclick="searchBooks()">بحث</button>
        </div>
        <div id="results" class="mt-4"></div>
        <nav aria-label="Page navigation">
            <ul class="pagination" id="pagination"></ul>
        </nav>
        <div id="error" class="alert alert-danger d-none" role="alert"></div>
    </div>

    <script>
        let booksData = [];
        let currentPage = 1;
        const resultsPerPage = 10;

        // Fetch books.json data
        async function fetchBooks() {
            try {
                const response = await fetch('books.json');
                if (!response.ok) throw new Error('فشل في جلب بيانات الكتب');
                booksData = await response.json();
                searchBooks(); // Initial display
            } catch (error) {
                showError('خطأ: ' + error.message);
            }
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
        }

        // Search and display results
        function searchBooks() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const lang = document.getElementById('languageSelect').value;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            // Filter books
            const filteredBooks = booksData.books.filter(book => {
                const title = book.titles[lang].toLowerCase();
                const description = book.description[lang].toLowerCase();
                const topics = book.metadata.topics.map(topic => topic.toLowerCase());
                return title.includes(query) || description.includes(query) || topics.some(topic => topic.includes(query));
            });

            // Pagination
            const totalPages = Math.ceil(filteredBooks.length / resultsPerPage);
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const paginatedBooks = filteredBooks.slice(startIndex, endIndex);

            // Display results
            if (paginatedBooks.length === 0) {
                resultsDiv.innerHTML = '<p class="text-center">لم يتم العثور على نتائج.</p>';
            } else {
                paginatedBooks.forEach(book => {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `
                        <h3>${book.titles[lang]}</h3>
                        <p>${book.description[lang]}</p>
                        <div class="links">
                            <a href="${book.links[lang].html}" target="_blank" class="btn btn-sm btn-outline-primary">HTML</a>
                            <a href="${book.links[lang].pdf}" target="_blank" class="btn btn-sm btn-outline-primary">PDF</a>
                            <a href="${book.links[lang].text}" target="_blank" class="btn btn-sm btn-outline-primary">Text</a>
                        </div>
                        <p><small>الفئة: ${book.metadata.category} | الصفحات: ${book.metadata.pages} | الفصول: ${book.metadata.chapters}</small></p>
                    `;
                    resultsDiv.appendChild(card);
                });
            }

            // Update pagination
            updatePagination(totalPages);
        }

        // Update pagination controls
        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">السابق</a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">التالي</a>`;
            pagination.appendChild(nextLi);
        }

        // Change page
        function changePage(page) {
            if (page < 1 || page > Math.ceil(booksData.books.length / resultsPerPage)) return;
            currentPage = page;
            searchBooks();
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1;
            searchBooks();
        });
        document.getElementById('languageSelect').addEventListener('change', () => {
            currentPage = 1;
            searchBooks();
        });

        // Initial fetch
        fetchBooks();
    </script>
</body>
</html>
